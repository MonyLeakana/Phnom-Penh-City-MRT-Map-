<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Base Map Editor</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #ffffff;
    }
    #app {
      padding: 16px 24px;
    }
    #toolbar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: 40px;
      margin-bottom: 12px;
    }
    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: 2px solid #222;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover { background: #f2f2f2; }
    #status {
      margin-left: auto;
      font-size: 0.9rem;
      color: #555;
    }

    #map-frame {
      margin: 0 40px;
      border: 2px solid #000;
      height: 70vh;
    }
    #map { width: 100%; height: 100%; }

    #bottom-row {
      margin-top: 18px;
      margin-left: 40px;
      margin-right: 40px;
      display: flex;
      justify-content: flex-start;
      font-size: 18px;
      line-height: 1.4;
    }
    #bottom-row strong {
      margin-right: 6px;
    }

    .edge-label {
      background: rgba(255,255,255,0.8);
      border: 1px solid #aaa;
      padding: 0 3px;
      border-radius: 3px;
      font-size: 10px;
      color: #222;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="toolbar">
      <button onclick="window.location.href='/'">Back to Design</button>
      <button id="undo-btn">Undo Station</button>
      <button id="erase-node-btn">Erase Station</button>
      <button id="erase-edge-btn">Erase Edge</button>
      <button id="auto-edge-btn">Auto Edge</button>
      <span id="status">Loading base map...</span>
    </div>

    <div id="map-frame">
      <div id="map"></div>
    </div>

    <div id="bottom-row">
      <strong>Total Distance (Base Map):</strong>
      <span id="base-total-distance">0.00 km</span>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const initialLat = 11.5564;
    const initialLng = 104.9282;
    const map = L.map("map").setView([initialLat, initialLng], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const statusEl = document.getElementById("status");
    const totalBaseDistanceEl = document.getElementById("base-total-distance");
    function setStatus(msg) { statusEl.textContent = msg; }

    const stations = new Map();
    const markers  = new Map();
    const polylines = new Map();
    let edgesCache = [];          // keep all base-map edges here to sum distance

    let selectedStationId = null;
    let eraseEdgeMode = false;
    let eraseNodeMode = false;

    const NODE_STYLE = {
      radius: 5,
      color: "#111",
      fillColor: "#fff",
      fillOpacity: 1,
      weight: 1
    };
    const EDGE_STYLE = {
      weight: 3,
      color: "#0074D9",
      opacity: 0.85
    };

    function updateTotalDistance() {
      let total = 0;
      for (const e of edgesCache) {
        if (typeof e.distance_km === "number") {
          total += e.distance_km;
        }
      }
      totalBaseDistanceEl.textContent = total.toFixed(2) + " km";
    }

    function clearAll() {
      markers.forEach(m => map.removeLayer(m));
      polylines.forEach(l => map.removeLayer(l));
      markers.clear();
      polylines.clear();
      stations.clear();
      edgesCache = [];
      updateTotalDistance();
    }

    function addMarkerFromPoint(point) {
      stations.set(point.id, point);
      const marker = L.circleMarker([point.lat, point.lng], NODE_STYLE).addTo(map);
      marker.bindPopup(
        `ID: ${point.id}<br>` +
        `Lat: ${point.lat.toFixed(5)}<br>` +
        `Lng: ${point.lng.toFixed(5)}`
      );
      marker.on("click", e => {
        L.DomEvent.stopPropagation(e);
        handleMarkerClick(point.id);
      });
      markers.set(point.id, marker);
    }

    function addEdgeFromData(edge, addToCache = true) {
      const s = stations.get(edge.from);
      const t = stations.get(edge.to);
      if (!s || !t) return;

      const line = L.polyline([[s.lat, s.lng],[t.lat, t.lng]], EDGE_STYLE).addTo(map);
      line.bindTooltip(`${edge.distance_km.toFixed(2)} km`, {
        permanent: true,
        direction: "center",
        className: "edge-label"
      });
      line.on("click", e => {
        L.DomEvent.stopPropagation(e);
        if (!eraseEdgeMode) return;
        deleteEdge(edge.id);
      });
      polylines.set(edge.id, line);

      if (addToCache) {
        edgesCache.push(edge);
        updateTotalDistance();
      }
    }

    function redrawFrom(nodes, edges) {
      clearAll();
      nodes.forEach(addMarkerFromPoint);
      edgesCache = edges.slice();
      edges.forEach(e => addEdgeFromData(e, false));
      updateTotalDistance();
    }

    function handleMarkerClick(stationId) {
      if (eraseNodeMode) {
        deleteNode(stationId);
        return;
      }
      if (eraseEdgeMode) {
        setStatus("Edge erase mode: click an edge to delete it.");
        return;
      }
      if (selectedStationId === null) {
        selectedStationId = stationId;
        setStatus(`Selected station #${stationId}. Click another station to connect.`);
      } else if (selectedStationId === stationId) {
        selectedStationId = null;
        setStatus("Selection cleared.");
      } else {
        const src = selectedStationId;
        const tgt = stationId;
        selectedStationId = null;
        createEdge(src, tgt);
      }
    }

    function createEdge(fromId, toId) {
      setStatus("Saving edge...");
      fetch("/basemap/add_edge", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: fromId, to: toId }),
      })
        .then(res => {
          if (!res.ok) throw new Error("Failed to save edge");
          return res.json();
        })
        .then(edge => {
          addEdgeFromData(edge, true);
          setStatus(
            `Edge #${edge.id} added: ${edge.from} ↔ ${edge.to} `
            + `(${edge.distance_km.toFixed(2)} km)`
          );
        })
        .catch(err => {
          console.error(err);
          setStatus("Error saving edge");
        });
    }

    function deleteEdge(edgeId) {
      setStatus(`Deleting edge #${edgeId}...`);
      fetch("/basemap/delete_edge", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ edge_id: edgeId }),
      })
        .then(res => {
          if (!res.ok) throw new Error("Failed to delete edge");
          return res.json();
        })
        .then(data => {
          const removed = data.removed;
          const line = polylines.get(removed.id);
          if (line) {
            map.removeLayer(line);
            polylines.delete(removed.id);
          }
          edgesCache = edgesCache.filter(e => e.id !== removed.id);
          updateTotalDistance();
          setStatus(`Deleted edge #${removed.id} (${removed.from} ↔ ${removed.to}).`);
        })
        .catch(err => {
          console.error(err);
          setStatus("Error deleting edge");
        });
    }

    function deleteNode(nodeId) {
      setStatus(`Deleting station #${nodeId}...`);
      fetch("/basemap/delete_node", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ node_id: nodeId }),
      })
        .then(res => {
          if (!res.ok) throw new Error("Failed to delete station");
          return res.json();
        })
        .then(data => {
          if (data.status !== "ok") throw new Error("Delete station error");
          const nodes = data.nodes || [];
          const edges = data.edges || [];
          redrawFrom(nodes, edges);
          eraseNodeMode = false;
          selectedStationId = null;
          setStatus(
            `Deleted station #${data.removed_node_id} and `
            + `${data.removed_edges_count} connected edge(s).`
          );
        })
        .catch(err => {
          console.error(err);
          setStatus("Error deleting station");
        });
    }

    // ---------- Initial load (MST as base map) ----------
    fetch("/basemap/points")
      .then(res => res.json())
      .then(points => {
        points.forEach(addMarkerFromPoint);
        setStatus(`Loaded ${points.length} base-map stations.`);
        return fetch("/basemap/edges");
      })
      .then(res => res.json())
      .then(edges => {
        edgesCache = edges.slice();
        edges.forEach(e => addEdgeFromData(e, false));
        updateTotalDistance();
        setStatus(`Loaded ${stations.size} stations and ${edges.length} MST edges.`);
      })
      .catch(err => {
        console.error(err);
        setStatus("Failed to load base map.");
      });

    // ---------- Map click: add node ----------
    map.on("click", function (e) {
      if (eraseEdgeMode || eraseNodeMode) {
        setStatus(
          eraseNodeMode
            ? "Station erase mode: click a station marker to delete it."
            : "Edge erase mode: click an edge to delete it."
        );
        return;
      }
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      setStatus("Saving station...");
      fetch("/basemap/add_point", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lng }),
      })
        .then(res => {
          if (!res.ok) throw new Error("Failed to save station");
          return res.json();
        })
        .then(point => {
          addMarkerFromPoint(point);
          setStatus(
            `Added station #${point.id} at (${lat.toFixed(5)}, ${lng.toFixed(5)}).`
          );
          if (selectedStationId !== null) {
            const src = selectedStationId;
            selectedStationId = null;
            createEdge(src, point.id);
          }
        })
        .catch(err => {
          console.error(err);
          setStatus("Error saving station");
        });
    });

    // ---------- Buttons ----------
    document.getElementById("undo-btn").addEventListener("click", function () {
      eraseEdgeMode = false;
      eraseNodeMode = false;
      setStatus("Undoing last station...");
      fetch("/basemap/undo", { method: "POST" })
        .then(res => {
          if (!res.ok) {
            if (res.status === 400) throw new Error("No stations to undo.");
            throw new Error("Undo failed.");
          }
          return res.json();
        })
        .then(data => {
          const removed = data.removed;
          const removedEdges = data.removed_edges || [];

          const marker = markers.get(removed.id);
          if (marker) {
            map.removeLayer(marker);
            markers.delete(removed.id);
          }
          stations.delete(removed.id);

          removedEdges.forEach(edge => {
            const poly = polylines.get(edge.id);
            if (poly) {
              map.removeLayer(poly);
              polylines.delete(edge.id);
            }
            edgesCache = edgesCache.filter(e => e.id !== edge.id);
          });
          updateTotalDistance();

          selectedStationId = null;
          setStatus(
            `Removed station #${removed.id} and ${removedEdges.length} edge(s).`
          );
        })
        .catch(err => {
          console.error(err);
          setStatus(err.message);
        });
    });

    document.getElementById("erase-edge-btn").addEventListener("click", function () {
      eraseEdgeMode = !eraseEdgeMode;
      eraseNodeMode = false;
      selectedStationId = null;
      if (eraseEdgeMode) {
        setStatus("Edge erase mode ON. Click an edge to delete it.");
      } else {
        setStatus("Edge erase mode OFF.");
      }
    });

    document.getElementById("erase-node-btn").addEventListener("click", function () {
      eraseNodeMode = !eraseNodeMode;
      eraseEdgeMode = false;
      selectedStationId = null;
      if (eraseNodeMode) {
        setStatus("Station erase mode ON. Click a station marker to delete it.");
      } else {
        setStatus("Station erase mode OFF.");
      }
    });

    document.getElementById("auto-edge-btn").addEventListener("click", function () {
      setStatus("Generating auto edges (> 1 km) on base map...");
      fetch("/basemap/auto_edges", { method: "POST" })
        .then(res => {
          if (!res.ok) throw new Error("Failed to auto-generate edges");
          return res.json();
        })
        .then(data => {
          const added = data.added || 0;
          const newEdges = data.edges || [];
          newEdges.forEach(e => addEdgeFromData(e, true));
          setStatus(`Auto edges added: ${added} new edge(s) (> 1 km).`);
        })
        .catch(err => {
          console.error(err);
          setStatus("Error generating auto edges");
        });
    });
  </script>
</body>
</html>
